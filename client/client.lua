-- â–ˆâ–ˆâ–ˆâ–„    â–ˆ  â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–’   â–ˆâ–“ â–„â–„â–„              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–„â–ˆâ–ˆâ–ˆâ–ˆâ–„   â–ˆâ–ˆâ–€â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–“ â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆ  â–„â–„â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
-- â–ˆâ–ˆ â–€â–ˆ   â–ˆ â–’â–ˆâ–ˆâ–’  â–ˆâ–ˆâ–’â–“â–ˆâ–ˆâ–‘   â–ˆâ–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–„          â–’â–ˆâ–ˆ    â–’ â–’â–ˆâ–ˆâ–€ â–€â–ˆ  â–“â–ˆâ–ˆ â–’ â–ˆâ–ˆâ–’â–“â–ˆâ–ˆâ–’â–“â–ˆâ–ˆâ–‘  â–ˆâ–ˆâ–’â–“  â–ˆâ–ˆâ–’ â–“â–’â–’â–ˆâ–ˆ    â–’
-- â–“â–ˆâ–ˆ  â–€â–ˆ â–ˆâ–ˆâ–’â–’â–ˆâ–ˆâ–‘  â–ˆâ–ˆâ–’ â–“â–ˆâ–ˆ  â–ˆâ–’â–‘â–’â–ˆâ–ˆ  â–€â–ˆâ–„        â–‘ â–“â–ˆâ–ˆâ–„   â–’â–“â–ˆ    â–„ â–“â–ˆâ–ˆ â–‘â–„â–ˆ â–’â–’â–ˆâ–ˆâ–’â–“â–ˆâ–ˆâ–‘ â–ˆâ–ˆâ–“â–’â–’ â–“â–ˆâ–ˆâ–‘ â–’â–‘â–‘ â–“â–ˆâ–ˆâ–„
-- â–“â–ˆâ–ˆâ–’  â–â–Œâ–ˆâ–ˆâ–’â–’â–ˆâ–ˆ   â–ˆâ–ˆâ–‘  â–’â–ˆâ–ˆ â–ˆâ–‘â–‘â–‘â–ˆâ–ˆâ–„â–„â–„â–„â–ˆâ–ˆ         â–’   â–ˆâ–ˆâ–’â–’â–“â–“â–„ â–„â–ˆâ–ˆâ–’â–’â–ˆâ–ˆâ–€â–€â–ˆâ–„  â–‘â–ˆâ–ˆâ–‘â–’â–ˆâ–ˆâ–„â–ˆâ–“â–’ â–’â–‘ â–“â–ˆâ–ˆâ–“ â–‘   â–’   â–ˆâ–ˆâ–’
-- â–’â–ˆâ–ˆâ–‘   â–“â–ˆâ–ˆâ–‘â–‘ â–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘   â–’â–€â–ˆâ–‘   â–“â–ˆ   â–“â–ˆâ–ˆâ–’      â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–’â–’ â–“â–ˆâ–ˆâ–ˆâ–€ â–‘â–‘â–ˆâ–ˆâ–“ â–’â–ˆâ–ˆâ–’â–‘â–ˆâ–ˆâ–‘â–’â–ˆâ–ˆâ–’ â–‘  â–‘  â–’â–ˆâ–ˆâ–’ â–‘ â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–’
-- â–‘ â–’â–‘   â–’ â–’ â–‘ â–’â–‘â–’â–‘â–’â–‘    â–‘ â–â–‘   â–’â–’   â–“â–’â–ˆâ–‘      â–’ â–’â–“â–’ â–’ â–‘â–‘ â–‘â–’ â–’  â–‘â–‘ â–’â–“ â–‘â–’â–“â–‘â–‘â–“  â–’â–“â–’â–‘ â–‘  â–‘  â–’ â–‘â–‘   â–’ â–’â–“â–’ â–’ â–‘
-- â–‘ â–‘â–‘   â–‘ â–’â–‘  â–‘ â–’ â–’â–‘    â–‘ â–‘â–‘    â–’   â–’â–’ â–‘      â–‘ â–‘â–’  â–‘ â–‘  â–‘  â–’     â–‘â–’ â–‘ â–’â–‘ â–’ â–‘â–‘â–’ â–‘         â–‘    â–‘ â–‘â–’  â–‘ â–‘
--   â–‘   â–‘ â–‘ â–‘ â–‘ â–‘ â–’       â–‘â–‘    â–‘   â–’         â–‘  â–‘  â–‘  â–‘          â–‘â–‘   â–‘  â–’ â–‘â–‘â–‘         â–‘      â–‘  â–‘  â–‘
--         â–‘     â–‘ â–‘        â–‘        â–‘  â–‘            â–‘  â–‘ â–‘         â–‘      â–‘                          â–‘
--                         â–‘                            â–‘

-- ğ—§ğ—µğ—®ğ—»ğ—¸ ğ˜†ğ—¼ğ˜‚ ğ—³ğ—¼ğ—¿ ğ—¶ğ—»ğ˜€ğ˜ğ—®ğ—¹ğ—¹ğ—¶ğ—»ğ—´ ğ—¼ğ˜‚ğ—¿ ğ—®ğ—»ğ˜ğ—¶-ğ˜ƒğ—±ğ—º ğ˜€ğ˜†ğ˜€ğ˜ğ—²ğ—º

-- ğ—³ğ—¼ğ—¿ ğ—®ğ—»ğ˜† ğ—½ğ—¿ğ—¼ğ—¯ğ—¹ğ—²ğ—º ğ—¼ğ—¿ ğ—¶ğ—»ğ—³ğ—¼ğ—¿ğ—ºğ—®ğ˜ğ—¶ğ—¼ğ—» ğ—±ğ—¼ ğ—»ğ—¼ğ˜ ğ—µğ—²ğ˜€ğ—¶ğ˜ğ—®ğ˜ğ—² ğ˜ğ—¼ ğ—²ğ—»ğ˜ğ—²ğ—¿ ğ—¼ğ˜‚ğ—¿ https://discord.gg/HNhCsR9cHU

-- ğ—ºğ—®ğ—»ğ˜† ğ—»ğ—²ğ˜„ ğ˜ğ—µğ—¶ğ—»ğ—´ğ˜€ ğ˜„ğ—¶ğ—¹ğ—¹ ğ—®ğ—¿ğ—¿ğ—¶ğ˜ƒğ—² ğ—¶ğ—» ğ—¼ğ˜‚ğ—¿ ğ—±ğ—¶ğ˜€ğ—°ğ—¼ğ—¿ğ—±, ğ˜€ğ˜‚ğ—°ğ—µ ğ—®ğ˜€ ğ—ºğ—®ğ—»ğ˜† ğ—³ğ—¿ğ—²ğ—² ğ—±ğ—¿ğ—¼ğ—½ğ˜€ ğ—®ğ—»ğ—± ğ—ºğ˜‚ğ—°ğ—µ ğ—ºğ—¼ğ—¿ğ—²

-- ali545 (754332358848807012)
-- locomedy. (975023885676326983)

local adding = false
local previousHealth = 100

CreateThread(function()
    while true do
        local playerPed = PlayerPedId()
        previousHealth = GetEntityHealth(playerPed)
        Wait(10 * 1000)
    end
end)

AddEventHandler("entityDamaged", function(entity, attacker, weapon, damage)
    if IsEntityAPed(entity) and entity == PlayerPedId() then
        local targetPed = entity
        local attackerPed = attacker

        if weapon == 0 or weapon == -1553120962 then
            if IsPedInAnyVehicle(attackerPed, false) and GetPedInVehicleSeat(attackerPed, -1) then
                if not adding then
                    adding = true
                    local attackerServerId = GetPlayerServerId(NetworkGetPlayerIndexFromPed(attackerPed))
                    SetEntityInvincible(targetPed, true)

                    TriggerServerEvent("nova_antivdm:warn", "CODICEANTITRIGGERANTIVDM121683GDSAÃ Ã²Ã¨PLÃ DS",
                        attackerServerId)
                    SetTimeout(1500, function()
                        adding = false
                    end)

                    if Config.CurarePlayer then
                        local currHealth = GetEntityHealth(targetPed)
                        print("curato", currHealth, IsEntityDead(targetPed))
                        if currHealth <= 0 or IsEntityDead(targetPed) then
                            if GetResourceState('qb-core'):find('start') then -- qb needs a wait becuase ...
                                Wait(7500)
                            end
                            SetEntityHealth(targetPed, 0)
                            Config.revivePlayer(GetPlayerServerId(NetworkGetPlayerIndexFromPed(targetPed)))
                            Config.sendNotification(Config.Lang["title"], Config.Lang["ress"])
                        end

                        while HasEntityCollidedWithAnything(targetPed) do
                            SetEntityHealth(targetPed, previousHealth < 10 and 200 or previousHealth)
                            Wait(1)
                        end

                        SetEntityHealth(targetPed, previousHealth < 10 and 200 or previousHealth)
                    end
                    Wait(2000)
                    SetEntityInvincible(targetPed, false)
                end
            end
        end
    end
end)

---@param target securityCode
---@param num webhook
RegisterNetEvent("nova_antivdm:warn", function(target, num)
    if target ~= "CODICEANTITRIGGERANTIVDM121683GDSAÃ Ã²Ã¨PLÃ DS" then
        TriggerServerEvent("nova_antivdm:banPlayer", "event")
        return
    end
    local playerPed = PlayerPedId()

    if IsPedInAnyVehicle(playerPed, false) then
        if Config.UseNotificationSound then
            PlaySoundFrontend(-1, Config.NotificationSound[1], Config.NotificationSound[2], 1)
        end

        SetTimeout(200, function()
            exports['screenshot-basic']:requestScreenshotUpload(num, 'files[]', function(data)
                local resp = json.decode(data)
                if resp.attachments then
                end
            end)
        end)

        SetTimeout(Config.VdmRemover * 60000, function()
            if LocalPlayer.state.vdmCounter > 0 then
                LocalPlayer.state:set("vdmCounter", (LocalPlayer.state.vdmCounter - 1), true)
            end
        end)

        LocalPlayer.state:set("vdmCounter", ((LocalPlayer.state.vdmCounter or 0) + 1), true)
        Config.sendNotification(Config.Lang["title"], ("%s %s"):format(LocalPlayer.state.vdmCounter, Config.Lang["desc"]))
    end
end)

-- RegisterCommand("resetVdm", function()
--     print("fatto")
--     LocalPlayer.state.vdmCounter = 0
-- end)
-- RegisterCommand("vdmcounter", function()
--     print(LocalPlayer.state.vdmCounter)
-- end)


AddStateBagChangeHandler('vdmCounter', nil, function(bagName, key, value)
    local isStatePlayer = bagName:gsub('player:', '')
    if not value then return end

    if isStatePlayer then
        if key == "vdmCounter" then -- double check
            if value >= Config.VdmChance then
                TriggerServerEvent("nova_antivdm:banPlayer")
            end
        end
    end
end)

